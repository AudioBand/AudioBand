<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Project layout </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="Project layout ">
    
    
      <link rel="shortcut icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../../styles/docfx.css">
      <link rel="stylesheet" href="../../styles/main.css">
      <meta property="docfx:navrel" content="../../toc.html">
      <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">

        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first=First data-prev=Previous data-next=Next data-last=Last></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="project-layout">Project layout</h1>

<p>Last commit at this time of writing / update: <code>33d68c84bd484d8b6f09bafcde2df08f2a853e23</code></p>
<p>Here are the main projects in the solution:</p>
<ul>
<li><strong>AudioBand</strong>: The is the &quot;main&quot; project where audioband lives</li>
<li><strong>AudioBand.Logging</strong>: This project contains shared logging facilities</li>
<li><strong>AudioBand.AudioSource</strong>: This project contains the audiosource interface</li>
<li><strong>AudioBand.Test</strong>: This project contains Tests to test the functionality of AudioBand.</li>
<li><strong>AudioSourceHost</strong>: This project contains the assembly used to host an audio source in a separate app domain</li>
<li>*<strong>AudioSource</strong>: These are the projects for the included audio sources.</li>
<li><strong>AudioBandInstaller</strong>: Can be ignored for most developers, this project handles creating the installer (.msi).</li>
</ul>
<h1 id="audioband-project">AudioBand project</h1>
<h2 id="entry-point">Entry point</h2>
<p>The entry point for audioband can be found in the <code>Deskband.cs</code> file. This is the composition root of the application. It's the equivalent of the main function in a normal winforms or wpf application but instead of calling <code>Application.Run()</code>, the root user control is instantiated directly. There is no <code>main window</code>. The toolbar is implemented as a WPF usercontrol in <code>UI/Toolbar/AudioBandToolbar.xaml</code></p>
<h2 id="audiobandtoolbarxaml">AudioBandToolbar.xaml</h2>
<p>This is the top level user control, equivalent to the main window in wpf or main form in winforms.</p>
<h3 id="codebehind">Codebehind</h3>
<p>The codebehind listens to size changes and notifies windows to update the deskband size.</p>
<h3 id="viewmodel">ViewModel</h3>
<p>The viewmodel for the toolbar can be found in <code>ViewModels/AudioBandToolbarViewModel</code>. It handles the context menu, loading the audio sources, and updating other view models when the audio source changes. When the toolbar is loaded, the <code>LoadCommand</code> is invoked, starting the step in initialization: loading the audio sources.</p>
<h2 id="audio-source-loading">Audio source loading</h2>
<p>Audio source loading is done by the <code>AudioSource/AudioSourceManager</code> class. Each audio source is loaded in their own app domain using the <code>AudioSourceHost</code> project. The creation and communication with the app domain is done through the <code>AudioSource/AudioSourceProxy</code> class. Currently, all audio sources are loaded at the start by the toolbar viewmodel, and there is no file system monitoring for new sources. For each audio source, these steps are performed:</p>
<ol>
<li>Add to the observable collection for the context menu</li>
<li>Merge settings.
<ol>
<li>If there are already saved settings for the audio source, then the settings are applied to the audio source</li>
<li>If there are no previously saved settings, then the default setting values are extracted and saved</li>
<li>Viewmodels for these settings are built and added so they can be manipulated in the settings window ui</li>
</ol>
</li>
<li>If the audio source is selected in the settings, then it is activated.</li>
</ol>
<h2 id="app-settings-loading">App settings loading</h2>
<h3 id="new-settings-v010-and-upwards">New Settings (v0.10 and upwards)</h3>
<p>The current settings use <code>json</code> to store information. The <code>Settings/AppSettings</code> is how the settings are opened up to the rest of the code, while <code>Settings/Persistence/Settings</code> is the Datatype that actual gets written/read by <code>Settings/Persistence/PersistentSettings</code>.</p>
<p>You should avoid manually editing the settings files, and when writing code for AudioBand you should always make sure this is avoided.</p>
<h3 id="old-settings-up-until-v0910">Old Settings (up until v0.9.10)</h3>
<div class="NOTE">
<h5>Note</h5>
<p>The Old Settings description was written before the new settings system was in place.</p>
</div>
<p>App settings are loaded and exposed by the <code>Settings/AppSettings</code> class. Persistence is done through <code>Settings/Persistence/PersistSettings</code>. The serialization format for settings uses the <code>toml</code> format. Toml is used because when the project was created, configuration was simple and editing the file in a text editor was the way to change settings. Toml was a good use case for that. Now, the settings have more nesting and more lists, which is less readable with toml however there is now a settings UI so editing the file isn't required. So migration to another serialization format isn't something required for now.</p>
<h3 id="settings-migrations">Settings migrations</h3>
<div class="NOTE">
<h5>Note</h5>
<p>Starting with the new system, migrations are no longer needed when adding settings (automatically handled). Though they are kept to allow older users to update with ease to the newest versions.</p>
</div>
<p>As the settings evolve, the serialization format can change so there are settings migrations located in the <code>Migrations</code> subfolder. These classes update old configuration files to the latest format. If an older version of the settings is detected, then a lookup is done in <code>SettingsMigration.cs</code> to find the appropriate way to transform the settings file. Mapping is done with <code>AutoMapper</code>.</p>
<h2 id="views-and-viewmodels">Views and ViewModels</h2>
<p>Views and viewmodels are stored together in the <code>UI</code> subfolder.</p>
<p>No MVVM frameworks are used, instead there is a <code>ViewModelBase</code> implementation and standard <code>ICommand</code> implementations.</p>
<p><code>ViewModelBase</code> provides automatic implementations for</p>
<ul>
<li><code>INotifyPropertyChanged</code>: Has a <code>SetProperty</code> method that automatically calls <code>INotifyPropertyChanged.PropertyChanged</code> event if a field value changes. The attribute <code>AlsoNotify</code> can also be applied to raise <code>PropertyChanged</code> for other properties. Example:</li>
</ul>
<pre><code class="lang-csharp">[AlsoNotify(nameof(Size))]
public int Width
{
    get =&gt; _width;
    set =&gt; SetProperty(ref _width, value);
}

public Size Size =&gt; new Size(Width, Height);
</code></pre>
<ul>
<li><code>INotifyDataError</code>: Provides a few <code>RaiseValidationError</code> methods that raise the <code>INotifyDataError.ErrorsChanged</code> event.</li>
<li><code>IResettable</code>: Custom interface that exposes a method to reset the viewmodel to default values. The base class implements a command to call reset and the method <code>ResetObject&lt;T&gt;</code> to reset an object to its default value.</li>
<li><code>BeginEdit</code>,<code>EndEdit</code> and <code>CancelEdit</code> commands and methods. The attribute <code>TrackState</code> can is used to automatically call those methods.</li>
</ul>
<pre><code class="lang-csharp">// Automatically calls BeginEdit method if the value is changed
[TrackState]
public int Width
{
    get =&gt; Model.Width; // Using the model as the source for the value
    set =&gt; SetProperty(Model, nameof(Model.Width), value); // Set the value in the model
}
</code></pre>
<h2 id="message-bus">Message bus</h2>
<p>Under the <code>Messages</code> folder there is a simple <code>IMessageBus</code> interface. Messages are used sparingly for communicating between the Settings Window &lt;-&gt; Toolbar and between ViewModels.</p>
<h2 id="other">Other</h2>
<h3 id="dpi">Dpi</h3>
<p>Since we are in an interop scenario, there are some issues with automatic dpi handling so it is done manually through the <code>DpiScaling</code> behavior located in the <code>UI/behaviors</code> folder.</p>
<h1 id="audiosourcehost-project">AudioSourceHost project</h1>
<p>The <code>AudioSourceHost</code> project is a library to load an audio source and exposes it via <code>MarshalByRef</code> objects for cross app domain communication. It uses the <code>Microsoft Extensibility Framework</code> to locate and load an <code>IAudioSource</code>.</p>

</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/AudioBand/AudioBand/blob/gh-pages/docfx/audioband/development/project-layout.md/#L1" class="contribution-link">Edit this page</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In this article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      
      <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
